<ion-header class="ion-no-border">
  <ion-toolbar color="transparent">
    <ion-buttons slot="start">
      <ion-button (click)="previousStep()" color="dark">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Nouvelle Mesure</ion-title>
    <!-- Progress: 1/3 ~ 0.33, 2/3 ~ 0.66, 3/3 ~ 1.0 -->
    <ion-progress-bar [value]="currentStep / 3" color="primary"></ion-progress-bar>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="wizard-content">
  
  <div class="wizard-container">
    
    <!-- Step 1: Details (No Age/Weight) -->
    <div *ngIf="currentStep === 1" class="fade-in">
      <div class="step-header">
        <h2>Informations Client</h2>
        <p>Sexe et taille</p>
      </div>

      <!-- Gender Selector -->
      <div class="gender-selector">
        <div class="gender-card" [class.selected]="gender === 'male'" (click)="gender = 'male'">
          <ion-icon name="man-outline"></ion-icon>
          <span>Homme</span>
        </div>
        <div class="gender-card" [class.selected]="gender === 'female'" (click)="gender = 'female'">
          <ion-icon name="woman-outline"></ion-icon>
          <span>Femme</span>
        </div>
      </div>

      <!-- Inputs Grid -->
      <div class="inputs-grid">
        <div class="input-group">
          <label>Nom du client <span class="required">*</span></label>
          <ion-input type="text" placeholder="Ex: Jean Dupont" [(ngModel)]="name" class="custom-input"></ion-input>
        </div>

        <div class="input-group">
          <label>Téléphone <span class="optional">(optionnel)</span></label>
          <ion-input type="tel" placeholder="Ex: 01 23 45 67 89" [(ngModel)]="phone" class="custom-input"></ion-input>
        </div>

        <div class="input-group">
          <label>Taille (m) <span class="required">*</span></label>
          <ion-input type="number" step="0.01" placeholder="1.75" [(ngModel)]="height" class="custom-input"></ion-input>
        </div>
      </div>

      <div class="footer-action">
        <ion-button expand="block" shape="round" size="large" (click)="nextStep()" [disabled]="!height">
          Suivant
          <ion-icon slot="end" name="arrow-forward"></ion-icon>
        </ion-button>
      </div>
    </div>

    <!-- Step 2: Measurement Selection -->
    <div *ngIf="currentStep === 2" class="fade-in">
      <div class="step-header">
        <h2>Mesures souhaitées</h2>
        <p>Sélectionnez les mesures à extraire</p>
      </div>

      <div class="measures-selection">
        <ion-item lines="none" class="select-all-item">
          <ion-label>Tout sélectionner</ion-label>
          <ion-checkbox slot="end" [checked]="selectedMeasures.length === availableMeasures.length" (ionChange)="toggleAll($event)"></ion-checkbox>
        </ion-item>

        <div class="measures-grid">
          <div 
            class="measure-chip" 
            *ngFor="let m of availableMeasures" 
            [class.selected]="selectedMeasures.includes(m)"
            (click)="toggleMeasure(m)"
          >
            <ion-icon [name]="selectedMeasures.includes(m) ? 'checkmark-circle' : 'ellipse-outline'"></ion-icon>
            <span>{{ m }}</span>
          </div>
        </div>
      </div>

      <div class="footer-action">
        <ion-button expand="block" shape="round" size="large" (click)="nextStep()" [disabled]="selectedMeasures.length === 0">
          Suivant
          <ion-icon slot="end" name="arrow-forward"></ion-icon>
        </ion-button>
        <p class="count-info">{{ selectedMeasures.length }} mesures sélectionnées</p>
      </div>
    </div>

    <!-- Step 3: Photos -->
    <div *ngIf="currentStep === 3" class="fade-in">
      <div class="step-header">
        <h2>Capture 3D</h2>
        <p>Portez des vêtements près du corps.</p>
      </div>

      <div class="photos-container">
        <!-- Front Photo -->
        <div class="photo-card" (click)="takePhoto('front')" [class.has-photo]="!!frontPhotoWebPath">
           <img *ngIf="frontPhotoWebPath" [src]="frontPhotoWebPath" class="photo-preview" />
           <div class="photo-placeholder" *ngIf="!frontPhotoWebPath">
             <ion-icon name="body-outline"></ion-icon>
             <span>Face</span>
             <ion-icon name="add-circle" color="primary" class="add-icon"></ion-icon>
           </div>
        </div>

        <!-- Side Photo -->
        <div class="photo-card" (click)="takePhoto('side')" [class.has-photo]="!!sidePhotoWebPath">
          <img *ngIf="sidePhotoWebPath" [src]="sidePhotoWebPath" class="photo-preview" />
          <div class="photo-placeholder" *ngIf="!sidePhotoWebPath">
            <ion-icon name="accessibility-outline"></ion-icon>
            <span>Profil</span>
            <ion-icon name="add-circle" color="primary" class="add-icon"></ion-icon>
          </div>
       </div>
      </div>

      <div class="footer-action">
        <ion-button expand="block" shape="round" size="large" (click)="startEstimation()" [disabled]="!frontPhoto || !sidePhoto || isLoading">
          <span *ngIf="!isLoading">Lancer l'analyse</span>
          <ion-spinner *ngIf="isLoading"></ion-spinner>
        </ion-button>
        <div class="secure-note">
          <ion-icon name="lock-closed-outline"></ion-icon>
          <small>Photos cryptées et sécurisées</small>
        </div>
      </div>
    </div>

  </div>

</ion-content>
